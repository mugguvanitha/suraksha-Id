{% extends "base.html" %}

{% block title %}Admin Dashboard - SurakshaID{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Header Section -->
        <div class="col-12 mb-4">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h2 class="card-title">
                        <i class="fas fa-user-cog"></i> Admin Control Panel
                    </h2>
                    <p class="card-text">System overview and administrative controls</p>
                </div>
            </div>
        </div>
    </div>
	
   <form method="POST" action="{{ url_for('create_authorized') }}" class="mb-4">

    <div class="row g-3 align-items-end">

        <!-- Email -->
        <div class="col-md-3">
            <label class="form-label">Email</label>
            <input type="email" name="email"
                   class="form-control"
                   placeholder="Email" required>
        </div>

        <!-- Password -->
        <div class="col-md-3 position-relative">
            <label class="form-label">Password</label>
            <input type="password"
                   name="password"
                   id="createAuthPassword"
                   class="form-control"
                   required>

            <i class="fas fa-eye position-absolute"
               id="toggleCreateAuthPassword"
               style="top: 38px; right: 15px; cursor: pointer;"></i>
        </div>

        <!-- Role -->
        <div class="col-md-2">
            <label class="form-label">Select Role</label>
            <select name="role_type" id="role_type"
                    class="form-select"
                    required onchange="toggleRole()">
                <option value="">Select</option>
                <option value="AUTHORIZED">Authorized</option>
                <option value="COMPANY">Company</option>
            </select>
        </div>

        <!-- Verifier Type -->
        <div class="col-md-2" id="verifier_section">
            <label class="form-label">Verifier</label>
            <select name="verifier_type" class="form-select">
                <option value="POLICE">Police</option>
                <option value="ADDRESS">Address</option>
                <option value="CRIMINAL">Criminal</option>
            </select>
        </div>

        <!-- Company Name -->
        <div class="col-md-2" id="company_section" style="display:none;">
            <label class="form-label">Company</label>
            <input type="text"
                   name="company_name"
                   class="form-control"
                   placeholder="Company Name"
                   id="company_name_input">
        </div>

        <!-- Create Button -->
        <div class="col-md-2">
            <button type="submit" class="btn btn-success w-100">
                Create
            </button>
        </div>

    </div>
</form>
    <!-- Statistics Cards -->
    <div class="row mb-4">

    <div class="col-md-3">
        <a href="{{ url_for('admin_dashboard', filter_type='all') }}" style="text-decoration:none;">
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_users }}</div>
                <div class="stat-label">Total Users</div>
            </div>
        </a>
    </div>

    <div class="col-md-3">
        <a href="{{ url_for('admin_dashboard', filter_type='pending') }}" style="text-decoration:none;">
            <div class="stat-card">
                <div class="stat-number text-warning">{{ stats.pending_verifications }}</div>
                <div class="stat-label">Pending Verifications</div>
            </div>
        </a>
    </div>

    <div class="col-md-3">
        <a href="{{ url_for('admin_dashboard', filter_type='safe') }}" style="text-decoration:none;">
            <div class="stat-card">
                <div class="stat-number text-success">{{ stats.safe_users }}</div>
                <div class="stat-label">Safe Users</div>
            </div>
        </a>
    </div>

    <div class="col-md-3">
        <a href="{{ url_for('admin_dashboard', filter_type='restricted') }}" style="text-decoration:none;">
            <div class="stat-card">
                <div class="stat-number text-danger">{{ stats.restricted_users }}</div>
                <div class="stat-label">Restricted Users</div>
            </div>
        </a>
    </div>

</div>
{% if users %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users"></i> User Records 
                    <span class="badge bg-primary">{{ users|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Verification ID</th>
                                <th>Name</th>
                                <th>Police Status</th>
                                <th>Address Status</th>
                                <th>Criminal Status</th>
                                <th>Eligibility</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td><strong>{{ user.VERIFICATION_ID }}</strong></td>
                                <td>{{ user.NAME }}</td>

                                <td>
                                    <span class="status-badge status-{{ user.POLICE_VERIFICATION_STATUS.lower() }}">
                                        {{ user.POLICE_VERIFICATION_STATUS }}
                                    </span>
                                </td>

                                <td>
                                    <span class="status-badge status-{{ user.ADDRESS_VERIFICATION_STATUS.lower() }}">
                                        {{ user.ADDRESS_VERIFICATION_STATUS }}
                                    </span>
                                </td>

                                <td>
                                    <span class="status-badge status-{{ user.CRIMINAL_VERIFICATION_STATUS.lower() }}">
                                        {{ user.CRIMINAL_VERIFICATION_STATUS }}
                                    </span>
                                </td>

                                <td>
                                    <span class="status-badge status-{{ user.ELIGIBILITY_STATUS.lower() }}">
                                        {{ user.ELIGIBILITY_STATUS }}
                                    </span>
                                </td>
<td>
    <!-- Update Button -->
    <button class="btn btn-primary btn-sm"
            onclick="openAdminUpdateModal('{{ user.VERIFICATION_ID }}')">
        <i class="fas fa-edit"></i> Update
    </button>

    <!-- View Button -->
    <a href="{{ url_for('admin_view_user', vid=user.VERIFICATION_ID) }}"
       class="btn btn-dark btn-sm">
       <i class="fas fa-eye"></i> View
    </a>
	<a href="{{ url_for('delete_user', vid=user.VERIFICATION_ID) }}"
   class="btn btn-sm btn-danger"
   onclick="return confirm('Are you sure you want to delete this user?');">
   <i class="fas fa-trash"></i> Delete
</a>
</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
    <!-- Today's Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-calendar-day"></i> Today's Activity</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h4 class="text-primary">{{ stats.today_registrations }}</h4>
                            <p class="text-muted">New Registrations</p>
                        </div>
                        <div class="col-md-4">
                            <h4 class="text-success">{{ (stats.safe_users / stats.total_users * 100)|round(1) if stats.total_users > 0 else 0 }}%</h4>
                            <p class="text-muted">Safe User Rate</p>
                        </div>
                        <div class="col-md-4">
                            <h4 class="text-warning">{{ (stats.pending_verifications / stats.total_users * 100)|round(1) if stats.total_users > 0 else 0 }}%</h4>
                            <p class="text-muted">Pending Rate</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('admin_users') }}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-users"></i> View All Users
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('admin_audit_logs') }}" class="btn btn-outline-info w-100">
                                <i class="fas fa-history"></i> Audit Logs
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('admin_export', format='csv') }}" class="btn btn-outline-success w-100">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('admin_export', format='json') }}" class="btn btn-outline-warning w-100">
                                <i class="fas fa-file-code"></i> Export JSON
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Overview -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> User Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="userDistributionChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Verification Status</h5>
                </div>
                <div class="card-body">
                    <canvas id="verificationStatusChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity Summary -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> System Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Database Status</h6>
                            <p class="text-success"><i class="fas fa-check-circle"></i> Connected</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Last System Update</h6>
                            <p class="text-muted">{{ stats.today_registrations }}</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <h6><i class="fas fa-exclamation-triangle"></i> Admin Responsibilities</h6>
                        <ul class="mb-0">
                            <li>Monitor and manage user verification processes</li>
                            <li>Override verification decisions when necessary</li>
                            <li>Review audit logs for security monitoring</li>
                            <li>Export data for reporting and analysis</li>
                            <li>Ensure system integrity and data privacy</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ADMIN UPDATE MODAL -->
<div class="modal fade" id="adminUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Update Verification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <!-- REQUIRED -->
                <input type="hidden" id="verificationId">

                <div class="mb-3">
                    <label>Field</label>
                    <select id="fieldSelect" class="form-select">
                        <option value="POLICE">Police</option>
                        <option value="ADDRESS">Address</option>
                        <option value="CRIMINAL">Criminal</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label>Status</label>
                    <select id="statusSelect" class="form-select">
                        <option value="PENDING">PENDING</option>
                        <option value="CLEAR">CLEAR</option>
                        <option value="FLAGGED">FLAGGED</option>
                    </select>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-danger" onclick="updateVerification()">Update</button>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function openAdminUpdateModal(vid) {
    document.getElementById('verificationId').value = vid;
    var modal = new bootstrap.Modal(document.getElementById('adminUpdateModal'));
    modal.show();
}
document.getElementById("toggleCreateAuthPassword").addEventListener("click", function () {

    const passwordInput = document.getElementById("createAuthPassword");
    const icon = this;

    if (passwordInput.type === "password") {
        passwordInput.type = "text";
        icon.classList.remove("fa-eye");
        icon.classList.add("fa-eye-slash");
    } else {
        passwordInput.type = "password";
        icon.classList.remove("fa-eye-slash");
        icon.classList.add("fa-eye");
    }

});
function updateVerification() {

    var verificationId = document.getElementById('verificationId').value;
    var field = document.getElementById('fieldSelect').value;
    var newStatus = document.getElementById('statusSelect').value;

    var formData = new FormData();
    formData.append('verification_id', verificationId);
    formData.append('field', field);
    formData.append('status', newStatus);

    fetch('/admin/update_verification', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Updated Successfully");
            location.reload();
        } else {
            alert("Failed to update");
        }
    });
}
document.addEventListener('DOMContentLoaded', function() {

    const userCtx = document.getElementById('userDistributionChart').getContext('2d');
    new Chart(userCtx, {
        type: 'pie',
        data: {
            labels: ['Safe Users', 'Restricted Users'],
            datasets: [{
                data: [{{ stats.safe_users }}, {{ stats.restricted_users }}],
                backgroundColor: ['#27ae60', '#e74c3c']
            }]
        }
    });

});
const verificationCtx = document.getElementById('verificationStatusChart').getContext('2d');

new Chart(verificationCtx, {
    type: 'bar',
    data: {
        labels: ['Pending', 'Safe', 'Restricted'],
        datasets: [{
            label: 'Users',
            data: [
                {{ stats.pending_verifications }},
                {{ stats.safe_users }},
                {{ stats.restricted_users }}
            ],
            backgroundColor: ['#f1c40f', '#27ae60', '#e74c3c']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        }
    }
});
function toggleRole() {

    const role = document.getElementById("role_type").value;
    const verifierSection = document.getElementById("verifier_section");
    const companySection = document.getElementById("company_section");
    const companyInput = document.getElementById("company_name_input");

    if (role === "AUTHORIZED") {
        verifierSection.style.display = "block";
        companySection.style.display = "none";
        companyInput.required = false;
    }
    else if (role === "COMPANY") {
        verifierSection.style.display = "none";
        companySection.style.display = "block";
        companyInput.required = true;   // ðŸ”¥ make company name compulsory
    }
    else {
        verifierSection.style.display = "none";
        companySection.style.display = "none";
        companyInput.required = false;
    }
}
</script>
{% endblock %}
